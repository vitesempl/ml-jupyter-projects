В прошлом уроке мы разбирались с параметрическими критериями — критериями, которые предполагают, что поступающим на вход выборка взята из какого-то распределения, и проверяют гипотезы о значениях параметров этого распределения. В этом уроке у нас все будет наоборот. Мы будем рассматривать задачи вроде такой: есть выборка объема n из какого-то распределения F(x). Равно ли среднее значение значение случайной величины из которой эта выборка взята 0? Чтобы проверять любую гипотезу, нужна статистика T. Для этой статистики мы должны знать нулевое распределение, то есть распределение при условии справедливости нулевой гипотезы. Откуда его можно взять? Если мы что-то знаем про исходное распределение F(x) и как-то правильно и удачно выбрали статистику T, то распределение статистики, нулевое, может быть выражается аналитически. Но распределение F(x) может быть и нестандартным, и мы можем о нем вообще ничего не знать на самом деле. Гипотезы про среднее значение можно проверять с помощью центральной предельной теоремы, то есть с помощью Z-критерия фактически. Но центральная предельная теорема, мы знаем, действует не всегда. Иногда распределения бывают слишком скошенные, иногда выборка недостаточно большая, чтобы распределение ее выборочного среднего можно было считать нормальным. Что в этих ситуациях можно делать? Есть два варианта. Во-первых, нашу выборку из непонятного распределения можно превратить во что-то другое, распределение чего мы понимаем лучше. Второй вариант — о функции распределения нашей исходной выборки F(x) можно сделать какие-то предположения, и на основании этих предположений построить статистику, нулевое распределение которой мы сможем оценить. В методах, которые мы будем рассматривать в этом уроке, используются в разных комбинациях вот эти два способа работы с выборками.

В этом видео мы разберемся с одним из семейств непараметрических критериев: критериями знаков. Критерии знаков обладают достаточно невысокой мощностью, но они крайне универсальны, они практически ничего не требуют от данных, поэтому они очень полезны на практике. Для примера давайте рассмотрим данные, которые вы уже видели. Это время ремонта интернет-оборудования у клиентов, местных клиентов, провайдера Verizon. Выборка состоит из 23 наблюдений, и как видно по боксплоту и оценке плотности распределения, распределение признака не очень похоже на нормальное. Мы хотим понять, позволяют ли собранные данные утверждать, что среднее время ремонта составляет больше восьми часов, и использовать для этого параметрические критерии типа Стьюдента мы не можем, поскольку у нашего признака (у его распределения) тяжелый правый хвост, и кроме того, объем выборки достаточно маленький, поэтому мы не можем пользоваться центральной предельной теоремой. Решить эту задачу можно с помощью критерия знаков. Он принимает на вход выборку из произвольного распределения объема n и проверяет нулевую гипотезу о том, что медиана этого распределения равна некоторой константе m0, против любой односторонней или двусторонней альтернативы. Единственное, что мы будем требовать, — это чтобы в нашей выборке не было ни одного объекта, на котором значение признака X = в точности m0. Статистика, с помощью которой эта гипотеза проверяется, выглядит следующим образом: это сумма по всем объектам выборки индикаторов того, что Xi > m0. Если нулевая гипотеза справедлива, эта статистика имеет биномиальное распределение с параметрами n и 1/2. Итак, в задаче с временем ремонта интернет-оборудования мы проверяем нулевую гипотезу о том, что медиана времени ремонта составляет 8 часов, против односторонней альтернативы, которая утверждает, что ремонт в среднем длится дольше 8 часов, то есть медиана нашей выборки больше 8. В нашей выборке ремонт занял больше 8 часов в 15 случаях из 23. Много это или мало? Критерий знаков утверждает, что это недостаточно много. Его достигаемый уровень значимости, или вероятность получить 15 из 23 в условиях справедливости нулевой гипотезы, равен 0,1, то есть нулевая гипотеза не отвергается, данные не позволяют утверждать, что ремонт в среднем длится дольше 8 часов. Критерий знаков настолько всеяден, что его можно использовать даже на цензурированных выборках. Представьте, что вы наблюдаете пациентов с лимфоцитарной лимфомой, и признак, который вы измеряете, — это время их жизни после того, как был поставлен диагноз, в неделях. Исследование, которое вы проводите, длится семь лет. В нашей выборке есть один пациент, который после семи лет, или 362 недель наблюдений остался жив. Поскольку исследование закончилось, мы не знаем, сколько еще он прожил после этого. Такая выборка называется цензурированной сверху, поскольку на части объектов мы знаем только нижнюю границу на значение признака. Если мы хотим проверить гипотезу о том, что среднее время дожития составляет 200 недель, против односторонней альтернативы, что оно больше 200 недель, мы можем использовать для этой выборки без проблем критерий знаков. Его достигаемый уровень значимости равен 0,94. То есть против нашей односторонней альтернативы нулевую гипотезу отклонить нельзя. Следующая задача. Рассмотрим классификатор C4.5. Это один из способов построения деревьев решений. Представьте, что вы взяли 14 разных стандартных датасетов и посчитали на каждом из этих датасетов площадь под кривой на тестовой выборке для вашего классификатора. Так вы получили первой столбец вот этой таблицы. Далее, возьмем модификацию этого классификатора. Попробуем на обучающей выборке настраивать один из его гиперпараметров — это минимальное количество объектов в листе (m). Таким образом, на всех тех же самых 14 датасетах вы можете посчитать площадь под кривой для этого нового классификатора и получить второй столбец вашей таблицы. Какая из этих двух версий классификатора лучше? Ну, во-первых, можно заметить, что из 14 датасетов на 10 по площади под ROC-кривой побеждает вторая версия классификатора — она на нем больше. На двух датасетах выигрывает первая версия классификатора, и еще на двух у нас ничья. Для того чтобы по этим цифрам посчитать статистическую значимость, можно использовать критерий знаков для связанных выборок. Он принимает на вход две связанные выборки объема n и проверяет нулевую гипотезу о средних весьма экзотического вида. Она выглядит так: вероятность того, что X1 > X2, равна 1/2. И проверяется эта гипотеза против любой односторонней, двусторонней альтернативы, что вот эта вероятность < ≠ > 1/2. В этом уроке мы говорим про непараметрические критерии, которые проверяют гипотезы о средних, но под «средними» они часто понимают совершенно разные вещи. Так вот мы только что видели, что одновыборочный критерий знаков под средним понимает медиану. Двухвыборочный критерий знаков гипотезу о средних формулирует вот в таком достаточно экзотическом виде. Другие критерии могут использовать другие варианты нулевых гипотез, но тем не менее всё это — в каком-то виде утверждение о средних. Статистика двухвыборочного критерия знаков — это сумма индикаторов того, что элемент первой выборки больше, чем соответствующий элемент второй выборки. Если нулевая гипотеза справедлива, эта статистика точно так же имеет биномиальное распределение с параметрами n и 1/2. В задаче с качеством классификаторов мы хотим проверить нулевую гипотезу о том, что среднее их качество одинаково, и проверять мы ее будем против односторонней альтернативы о том, что качество модифицированного классификатора выше. Вообще, странно предполагать, что при настройке какого-то гиперпараметра мы получим в среднем падение качества классификатора, поэтому мы будем использовать именно одностороннюю альтернативу. Критерий знаков дает достигаемый уровень значимости 0,019, то есть на уровне значимости 0,05, мы отвергаем нулевую гипотезу о том, что у этих классификаторов качество одинаковое, против альтернативы о том, что второй классификатор лучше. Модифицированный алгоритм лучше на 83 % датасетов. 95 % нижний доверительный предел для доли датасетов, на которых модифицированный классификатор лучше, — 56,2 %. Итак, в этом видео мы поговорили о том, как для выборок из произвольных распределений проверять гипотезы о средних. Рецепт простой: нужно превратить вашу выборку в бинарную. Так поступает критерий знаков. Мы разобрали две его версии: одновыборочную и версию для связанных выборок. В следующем видео мы поговорим про еще одно семейство непараметрических критериев, которые выборки превращают в ранги.

Для проверки гипотез о средних критерии знаков выбрасывают большую часть информации, содержащуюся в выборке. Вместо исходных значений признака мы получаем бинарный вектор. Критерии, которые мы рассмотрим в этом видео – ранговые критерии – позволяют сохранить больше информации. Давайте для начала вспомним, что такое ранги. Если у нас есть выборка, мы всегда можем превратить её в вариационный ряд, то есть упорядочить её по не убыванию. Если при этом возникают какие-то куски вариационного ряда, в котором элементы полностью совпадают, эти куски называются «связками». Рангом наблюдения Xi называется его позиция в вариационном ряду. Если оно не попадает в связку, то это буквально его номер в вариационном ряду. А если Xi оказывается в связке, начиная от k1 до k2 элемента вариационного вариант, то его рангом будет среднее между k1 и k2. То есть в связке все объекты получают одинаковый средний ранг. Использовать ранги мы будем в следующей задаче: перед вами 24 шайбы, произведённые на одном и том же конвейере, для которых мы измерили диаметры. По этой выборке мы хотим понять соответствует ли диаметр шайбы стандартному размеру в 10 миллиметров. Для этого мы будем использовать критерии знаковых рангов, или еще иногда его называют критерием знаковых рангов Уилкоксона. Он принимает на вход выборку объёма n, в котрой нет ни одного элемента в точности равного m0. И, кроме того, мы предполагаем, то распределение случайной величины, из которой эта выборка взята, симметрична относительно своей медианы. Проверяется нулевая гипотеза о том, что медиана равна константе m0 против любой односторонней, двусторонней альтернативы. И делается это с помощью следующей статистики. Статистика W критерия знаковых рангов строится следующим образом: мы берём нашу выборку, вычитаем из неё m0, берём от всего модули, строим по полученным модулям вариационный ряд и считаем ранги, далее суммируем эти ранги со знаками разностей Xi и m0. Если нулевая гипотеза справедлива, такая статистика имеет табличное распределение. Откуда, как вы думаете, оно берётся? Ответ очень прост: дело в том, что при справедливости нулевой гипотезы, каждый из рангов в нашей выборке мог с одинаковой вероятностью реализоваться с любым знаком: и с «+», и с «−». Таким образом, мы получаем 2 в степени n вариантов распределения знаков по рангам. Переберём все эти варианты, и на каждом из этих вариантов знаков посчитаем значение статистики. Именно так строится нулевое распределение. Если у нас выборка объёма 5, нулевое распределение статистики знаковых рангов выглядит вот так. Если объём выборки равен 10, то вот так. Если 15, вот так. Вы ничего не заподозрили? Нулевое распределение нашей статистики становится похожим на нормальное, с ростом объёма выборки. Действительно, для него можно использовать нормальную аппроксимацию. Если у вас выборка объёмом больше 20, вот таким нормальным определением можно аппроксимировать нулевое. Задачей с диаметром шайбы мы проверяем нулевую гипотезу о том, что средний размер шайбы составляет 10 миллиметров, против двусторонней альтернативы. Критерий знаковых рангов даёт достигаемый уровень значимости 0.067, то есть нулевая гипотеза не отвергается. Выборочная медиана диаметра составляет 10.5 миллиметров. 95-процентный доверительный интервал для него – от 9.95 до 11.15 миллиметров. Доверительной интервал содержит наше m0 целевое значение – 10. Как и должно быть, когда достигаемый уровень значимости больше порога. После всего, что вы уже видели в этом курсе, вас не должно удивить, что двухвыборочная задача со связанными выборками решается ровно тем же самым критерием, что и одновыборочная. Перед вами версия критерия знаков для двух связанных выборок. Проверяется нулевая гипотеза о том, что медиана разности X1 и X2 равна нулю 0 против произвольной альтернативы, и делается это с помощью статистики, в которой суммируются ранги модулей попарных разностей X1 и X2 со знаками этих разностей. Нулевое распределение этой статистики абсолютно такое же. Рассмотрим следующую задачу: перед вами депрессивность 9 пациентов, измеренная по шкале Гамильтона до и после первого приёма транквилизатора. Мы хотим понять, действует ли транквилизатор, то есть снижается ли у этих пациентов депрессивность. Формально мы будем проверять нулевую гипотезу о том, что медиана попарных разностей наших депрессивностей до и после приёма транквилизаторов равна 0. И будем эту проверку делать против односторонней альтернативы, о том, что эта медиана меньше 0, то есть депрессивность снизилась. Критерий из знаковых рангов даёт достигаемый уровень значимости 0.019, то есть нулевая гипотеза в пользу нашей односторонней альтернативы отвергается. Медиана снижения составляет 0.49 пунктов. 95-процентный нижний доверительный предел для снижения – 0.175 пунктов. Рассмотрим теперь задачу с независимыми выборками. В этой задаче признак, который мы будем измерять, это респираторный обмен – соотношение числа молекул углекислого газа и кислорода в выдыхаемом воздухе. Этот респираторный обмен является косвенным признаком того, из чего в данный момент ваши мышцы вырабатывают энергию – из жиров или из углеводов. В эксперименте мы измеряем респираторный обмен у 18 испытуемых в процессе физических упражнений. За час до этого 9 из них получили таблетку кофеина, а оставшиеся 9 – таблетку плацебо. Мы хотим понять, повлиял ли кофеин на среднее значение показателей респираторного обмена. Эту задачу можно решить с помощью критерия Манни-Уитни, который ещё иногда называется критерием Уилкоксона Манни-Уитни. Он принимает на вход независимые выборки, и проверят нулевую гипотезу о том, что распределение величины, с которых эти выборки взяты, полностью в точности совпадают. Делает он это он против альтернативы сдвига, то есть, что распределение совпадает с точностью до аддитивного параметра дельта. Про этот параметр дельта мы можем предполагать, что он больше 0, меньше 0 или не равен 0. То есть альтернатива, таким образом, может быть односторонней и двусторонней. Если справедлива альтернативная гипотеза и между распределениями действительно есть сдвиг, то средние значения признаков в наших выборках будут различаться. Поэтому это тоже в каком-то виде гипотеза о средних. Для того чтобы построить статистику критерия Манни-Уитни, мы возьмём наши две выборки и свалим их в одну кучу. Для этой объединенной выборки построим вариационный ряд, посчитаем ранги, а далее статистикой будет сумма рангов элементов первой выборки в объединенном вариационном ряду. Нулевое распределение этой статистики тоже табличное. Давайте снова подумаем, откуда оно может взяться. Если нулевая гипотеза справедлива, то каждый из рангов с одинаковой вероятностью мог реализоваться как в выборке X1, так и в выборке X2. Переберём все возможные варианты того, как это могло произойти. Всего таких вариантов C (n1 + n2) по n1. На каждом из этих вариантов посчитаем значение статистики критериz Манни-Уитни. Именно так мы получим нулевое распределение. Вот так выглядит нулевое распределение в случае, когда у вас в первой выборке три объекта, а во второй четыре. Вот так, когда у вас в обоих выборках по пять объектов. Вот так, когда по десять. Мы снова сходимся к нормальному распределению. Для критерия Манни-Уитни также справедлива нормальная аппроксимация нулевого распределения, которая работает, если в каждой из выборок по меньшей мере десять объектов. В задаче с кофеином и респираторным обменом мы проверяем нулевую гипотезу о том, что среднее значение показателей в двух группах не отличаются, и делаем это против двухсторонней альтернативы. Критерий Манни-Уитни даёт нам достигаемый уровень значимости 0.0521. Это совсем немного больше нашего стандартного уровня значимости в 0.05 Сдвиг между средними значениями показателей в двух выборках составляет 6 пунктов, но 95-процентный доверительный интервал для этого сдвига от величины, которая примерно равна 0, но чуть-чуть меньше него, до 12, то есть в этот доверительный интервал – 0 – всё-таки попадает. Мы не можем отвергнуть нулевую гипотезу. Итак, в этом видео мы разобрались с ещё одним непараметрическим семейством критериев, проверяющих гипотезы о средних. Это ранговые критерии и наблюдения в выборках они превращают в ранги, то есть какая-то часть информации всё равно теряется, но сохраняется больше, чем у критериев знаков. За использование этой информации мы, к сожалению, вынуждены платить дополнительными предположениями о характере распределения случайных величин, из которых выборки взяты. Мы разобрали три ранговых критерия: это критерии знаковых рангов, одновыборочные для связанных выборок, и критерии Манна-Уитни для выборок независимых. В следующим видел мы поговорим про перестановочные критерии, которые действуют в условиях тех же самых предположений, что и ранговые, но не теряют вообще никакой информации.

[БЕЗ ЗВУКА] В этом видео мы разберемся еще с одним семейством непараметрических критериев — перестановочные критерии. Давайте для начала вспомним, как работали критерии ранговые. Мы брали наши выборки, превращали их в ранги, затем делали какое-то дополнительное предположение и на основании этого предположения получали, что разные конфигурации этих рангов могли реализоваться с той же самой вероятностью. Мы перебирали все эти конфигурации и считали на каждой конфигурации значение статистики, таким образом оценивали для нашей статистики нулевое распределение. Что если в этом алгоритме мы пропустим первый пункт, не будем превращать наши наблюдения в ранги, а все остальное будем делать точно так же? Именно так работают перестановочные критерии. Одновыборочный перестановочный критерий проверяет нулевую гипотезу о том, что математическое ожидание случайной величины, из которой выборка взята, равно некоторой константе m0. Дополнительно делается предположение о том, что распределение исходной случайной величины относительно математического ожидания симметрично. Статистикой перестановочного критерия в одновыборочной задаче может служить сумма разностей i-того значения x и m0. Если нулевая гипотеза справедлива, каждый из объектов выборки мог с одинаковой вероятностью реализоваться слева и справа от математического ожидания. Поэтому мы будем перебирать все 2 в степени n знаков, которые могут стоять в выражении для нашей статистики перед разностью xi − m0. И вот на основании этого перебора мы и восстановим нулевое распределение нашей статистики. Давайте вспомним задачу анализа диаметра шайб: по выборке из 24 элементов мы пытаемся понять, соответствует ли средний диаметр шайбы стандарту — 10 миллиметров. Проверяем эту нулевую гипотезу мы против двухсторонней альтернативы о том, что средний диаметр стандарту не соответствует. Критерий знаковых рангов в нашем случае давал достигаемый уровень значимости 0.067, и вот так выглядело его нулевое распределение. Если мы используем перестановочный критерий, его нулевое распределение выглядит вот так. Значение статистики, которая в нашем эксперименте реализовалась — это 14.6. Для того чтобы посчитать достигаемый уровень значимости, мы суммируем высоты всех столбиков, начиная от 14.6 и больше, а также от −14.6 и меньше, поскольку альтернатива у нас двухсторонняя. В результате мы получаем достигаемый уровень значимости, равный примерно 0.1, то есть нулевая гипотеза все еще не отвергается. Обратите внимание, что достигаемый уровень значимости перестановочного критерия — это фактически доля перебираемых перестановок, на которых мы получаем такое же или еще более экстремальное значение статистики. Двухвыборочная задача со связанными выборками решается абсолютно таким же критерием — от двух связанных выборок мы переходим к одной выборке соответствующих попарных разностей. Проверяем нулевую гипотезу вида матожидание X1 − X2 = 0. И делаем это с помощью статистики, равной просто сумме построенных нами попарных разностей. Чтобы рассчитать нулевое распределение этой статистики, перебираем 2 в степени n знаков, которые могут возникать перед этими слагаемыми, получаем ровно то же самое. В задаче с оценкой эффективности транквилизатора у нас есть девять пациентов, для которых до и после приема мы измерили депрессивность по шкале Гамильтона. И мы проверяем нулевую гипотезу о том, что депрессивность не изменилась, против односторонней альтернативы о том, что транквилизатор подействовал, то есть депрессивность снизилась. Критерий знаковых рангов давал достигаемый уровень значимости 0.019, и вот так выглядело его нулевое распределение. Нулевое распределение перестановочного критерия изображено на нижнем графике. Значение статистики, которое реализуется в нашем эксперименте — 3.887. Суммируя высоты всех столбиков, начиная от 3.887 и направо, мы получаем достигаемый уровень значимости, равный 0.04. Нулевая гипотеза отвергается в пользу односторонней альтернативы. Перестановочный критерий для независимых выборок выглядит абсолютно так же, как критерий Манна-Уитни за исключением того, что мы не делаем ранговые преобразования. Он проверяет нулевую гипотезу о том, что распределение случайных величин, из которых взяты две независимые выборки, полностью совпадают, против альтернативы сдвига. Отличается только его статистика. Статистика — это просто разность выборочных средних в этих двух выборках. Нулевое распределение точно так же, как и для критерия Манна-Уитни, получается перебором всех C из n1 + n2 по n1 размещений нашей объединенной выборки по выборкам X1 и X2 объемов n1 и n2. В задаче с анализом связей между кофеином и респираторным обменом мы проверяли нулевую гипотезу о том, что среднее значение показателей респираторного обмена не отличается в двух группах: пациентов, которые приняли кофеин и приняли плацебо — против двухсторонней альтернативы о том, что что-то изменилось. Критерий Манна-Уитни давал достигаемый уровень значимости 0.052. Вот так выглядело его нулевое распределение. На нижнем графике здесь нулевое распределение перестановочного критерия, который мы только что рассмотрели. Значение статистики, которое в эксперименте реализуется — 6.33, оно соответствует достигаемому уровню значимости 0.0578. Нулевая гипотеза все еще не отвергается. У перестановочных критериев есть некоторые особенности, о которых очень важно помнить. Во-первых, статистику для перестановочных критериев можно выбирать по-разному. В некоторых случаях это приводит к одному и тому же достигаемому уровню значимости, то есть, по сути, ни на что не влияет. Например, в одновыборочной задаче, если вы проверяете гипотезу о том, что математическое ожидание равно нулю, вы можете использовать в качестве статистики перестановочного критерия сумму элементов выборки, а можете — выборочное среднее. Нулевые распределения этих двух статистик будут отличаться только сдвигом и масштабом, поэтому достигаемый уровень значимости, посчитанный по ним, будет одним и тем же. В других случаях, по-разному выбирая статистику для перестановочного критерия, вы можете получать разные достигаемые уровни значимости. Например, распределения нулевые у статистик — выборочное среднее и выборочное среднее, деленное на выборочную дисперсию, умноженную на корень из n, — отличаются не только сдвигом и масштабом, поэтому достигаемый уровень значимости у таких критериев с этими двумя вариантами статистик тоже будут разные. Поэтому при выборе статистики для перестановочного критерия важно думать о том, какие из свойств исходной случайной величины для вас наиболее важны. Если вам неинтересно нормировать на выборочную дисперсию, не нужно этого делать. Перестановочные критерии придумал Рональд Фишер еще в начале XX века, однако активно их использовать начали только с появлением и широким распространением компьютеров, потому что для вычисления нулевых распределений этих критериев можно использовать только перестановки. В отличие от ранговых критериев, никаких нормальных аппроксимаций для нулевого распределения в случае больших выборок не существует, поэтому единственный способ оценить нулевое распределение статистики — это перебрать много перестановок. Поэтому точно посчитать достигаемый уровень значимости перестановочного критерия на больших выборках достаточно сложно. Хорошая новость заключается в том, что мы можем его посчитать приближенно. Для этого нужно взять просто какое-то случайное подмножество всех возможных перестановок. При этом достигаемый уровень значимости будет оценен с точностью примерно √p * (1 − p), деленное на количество перестановок, которое вы берете. На практике, как правило, достаточно просто взять несколько тысяч перестановок, и вы уже получите достаточно точную аппроксимацию достигаемого уровня значимости. Итак, в этом видео мы узнали, как работают перестановочные критерии. Они действуют в абсолютно тех же самых предположениях, что и ранговые, но учитывают больше информации за счет того, что никакое понижающее количество информации в данных преобразованиях не используется. В следующем видео мы поговорим про связь между перестановочными критериями и бутстрепом.

[БЕЗ ЗВУКА] Вы уже знаете, что доверительные интервалы для параметров тесно связаны с проверкой точечных гипотез об их значениях. Например, z-критерии для средних связаны с нормальными доверительными интервалами, критерии Стьюдента соответствуют доверительным интервалам, построенным с использованием распределения Стьюдента. Для перестановочных критериев ближайшим аналогом в мире доверительных интервалов является метод бутстрепа, однако отношения между ними не такие взаимнооднозначные. Именно об этом в этом видео мы и поговорим. Перестановочные критерии принимают на вход выборку или выборки, считают на них какую-то статистику. Далее делается дополнительное предположение о распределении, из которого эти выборки взяты. Это предположение порождает множество перестановок исходных данных, которые могли реализоваться с той же самой вероятностью, если нулевая гипотеза справедлива. На этих перестановках мы вычисляем значение статистики и таким образом оцениваем точно ее нулевое распределение. Бутстреп-методы работают в каком-то смысле похоже: они на вход тоже принимают выборку или выборки и считают значение статистики, которая оценивает интересующий нас параметр, а далее на основании исходных данных генерирует множество бутстреп-псевдовыборок, и на этих псевдовыборках считают значения интересующей нас статистики и таким образом оценивают ее распределение. Ключевых различий между этими методами несколько. Во-первых, перестановочный критерий использует дополнительное предположение. Именно это предположение позволяет нам породить множество перестановок, которые мы будем использовать. Во-вторых, перестановки, которые используются в перестановочном критерии, это выборки без возвращения, в то время как бутстреп-методы используют выборки с возвращением: бутстреп-псевдовыборки могут содержать повторяющиеся элементы исходной выборки. Кроме того, распределения, которые мы получаем, абсолютно разные, потому что распределение статистики перестановочного критерия — это распределение нулевое то есть то распределение, которое статистика будет иметь при справедливости нулевой гипотезы, в то время как распределение бутстреп-статистики никакой нулевой гипотезы не подразумевает вообще. Чтобы лучше это понять, давайте вспомним пример с кофеином и респираторным обменом. Напомню, что там мы проверяли нулевую гипотезу о том, что средние значения показателей респираторного обмена не отличаются в двух группах пациентов, которые приняли кофеин и приняли плацебо. Эта нулевая гипотеза проверяется против односторонней альтернативы о том, что под воздействием кофеина среднее значение показателей респираторного обмена снижается. На данных, которые мы анализируем, разность выборочных средних у значения показателей респираторного обмена у пациентов, которые приняли плацебо и которые приняли кофеин, составляет 6,33 пункта. На верхнем графике перед вами нулевое распределение перестановочного критерия со статистикой, равной разности выборочных средних на двух выборках. На нижнем графике — бутстреп-распределение той же самой статистики. Ключевое различие между ними в том, что они центрированы в разных местах. Перестановочное нулевое распределение центрировано в нуле, потому что это именно то значение, которое соответствует нашей нулевой гипотезе. Бутстреп-распределение, в свою очередь, центрировано в выборочном значении нашего параметра. Параметр в данном случае — это разность средних, то есть центр бутстреп-распределения — это 6,33. Для перестановочного критерия доля перестановок, на которых среднее больше либо равно 6,33, которое реализовалось на наших данных, составляет примерно 0,03. Это и есть достигаемый уровень значимости перестановочного критерия, и он точный. На бутстреп-распределении той же самой статистки доля псевдовыборок, на которых среднее меньше либо равно нулю, примерно 0,01. Эту величину можно считать приближенным достигаемым уровнем значимости бутстреп-критерия. То есть с помощью доверительных интервалов на основе бутстрепа тоже можно проверять гипотезы, просто это нужно делать немного по-другому. Давайте поговорим про эти различия подробнее. Перестановочный критерий с помощью нулевого распределения статистики каким-то образом измеряет расстояние от 0 до реализовавшегося в эксперименте значения нашего параметра Dn с чертой. Бутстреп-критерий в том виде, в котором мы только что его придумали, измеряет, наоборот, расстояние от выборочного среднего Dn с чертой до 0. Перестановочный критерий является точным, потому что в нем в идеале перебирается подмножество всех возможных перестановок данных, которые равновероятны при справедливости нулевой гипотезы. Бутстреп-критерий в таком виде, в котором мы его только что придумали, в свою очередь, является только приближенным, поскольку в нем мы всегда перебираем только конечное подмножество всех возможных бутстреп-псевдовыборок, их слишком много заведомо. Кроме того, самое важное различие между этими двумя критериями заключается в том, что они проверяют разные гипотезы, поскольку перестановочный критерий еще использует дополнительные предположения. По сути, гипотеза, которая проверяет перестановочный критерий, это гипотеза полного равенства распределений в двух наших выборках, и проверяется она против альтернативы сдвига, то есть что функции распределения отличаются только сдвигом. Никак иначе они отличаться вообще не могут. Бутстреп-критерий опять же в том виде, в котором мы сейчас его придумали, проверяет всего лишь гипотезу о равенстве математических ожиданий. Гипотезу равенства он проверяет против односторонней альтернативы точно так же, как и перестановочный критерий, но эта гипотеза заведомо более слабая. Не используется никакое предположение о том, что функции распределения в двух наших выборках равны. Проверка гипотез с помощью бутстрепа — это достаточно сложная задача. И вот этот небольшой двухвыборочный пример позволяет нам понять плюсы и минусы бутстрепа и перестановочных критериев. Бутстреп тоже позволяет проверять гипотезы, и с его помощью можно проверять гипотезы гораздо более широкого класса. Поскольку этот метод не использует дополнительных предположений, мы можем проверять только то, что нас интересует. Вот в нашем примере это было исключительно равенство математических ожиданий. Кроме того, с помощью бутстрепа можно проверять и другие крайне экзотические гипотезы, которые никакими другими методами проверить нельзя. Например, гипотеза о том, что распределение имеет ровно две моды. Если предположения, лежащие в основе перестановочного критерия, выполняются, то перестановочный критерий, во-первых, точнее, поскольку его достигаемый уровень значимости точный, во-вторых, всегда мощнее, чем аналогичный критерий бутстрепа. Но бутстреп при этом гораздо более гибок, то есть если предположения не выполняются, перестановочный критерий мы использовать не можем, а бутстреп — пожалуйста. В следующем видео вы увидите, как применяются разные непараметрические критерии.

В этом видео мы потренируемся применять непараметрические критерии. Их так же, как параметрические критерии, можно применять для одной, двух и двух связанных выборок. В этом видео мы поговорим про одновыборочную задачу и потренируемся применять следующие критерии: знаковые, ранговые и перестановочные. Решать будем такую задачу. В рамках исследования по улучшению жизни лабораторных мышей было проведено следующее исследование. Несколько мышей посадили в клетку, состоящую из двух комнат, в одной из которых висело зеркало. Измерялась доля времени, которую каждая из мышей проведет в комнате с зеркалом. Ну хотелось понять, есть ли у мышей какие-то предпочтения насчет зеркала и если они есть, то можно было бы повесить зеркала в клетке и тем самым улучшить условия мышей. Вот давайте эти данные загрузим и проанализируем. Видим, что данные представляют из себя вектор, каждое значение в котором соответствует доле времени, которое мышь провела в комнате с зеркалом. Давайте соберем простенькую статистику по этим данным. Видим, что у нас всего есть данные про 16 мышей, при этом в среднем мыши проводят 0,48 доли времени в комнате с зеркалом. При этом, эта доля меняется от 0,64 до 0,35, ну то есть в общем-то мы видим, что в среднем примерно половину времени, в районе половины времени, мыши проводят в комнате с зеркалом. Давайте построим гистограмму по этому параметру и увидим, что, ну да, действительно большая часть выборки колеблется где-то в районе половины времени. Теперь давайте это строго оценим. Ну первое, что можно сделать, это посчитать интервальную оценку на медиану времени. Вот видим, что наша медиана меняется от 0,44 до 0,51, ну то есть видим, что половина времени входит, хотя интервал больше сдвинут влево относительно половины. Теперь давайте потренируемся применять критерии. Начнем с критерия знаков. В данном случае мы с вами будем проверять гипотезу о том, что медиана доли времени, которую мыши проводят в комнате с зеркалом, равняется 0,5, ну то есть половина времени. А проверять эту гипотезу можно относительно двусторонней альтернативы, то есть о том, что медиана доли времени в комнате с зеркалом не равняется 0,5, так и против любой из односторонних альтернатив. То, что медиана доли времени меньше или больше, чем 0,5. Вот мы с вами начнем с двусторонней альтернативы и начнем с критерия знаков. Для этого мы будем пользоваться функцией sign_test из библиотеки statsmodels. В эту функцию нужно передать наши данные, это mouses data, и то значение, относительно которого мы гипотезу проверяем, то есть в нашем случае это 0.5. Давайте запустим функцию. Во-первых, она нам возвращает статистику −5 и p_value 0,02. Мы видим, что p_value достаточно маленькая, чтобы мы могли отклонить нулевую гипотезу на уровне значимости 0,05. Соответственно, делаем вывод о том, что медиана доли времени проведенного в клетке с зеркалом, все-таки отличается от 0,5. Значит у мышей, наверное, есть какие-то предпочтения. Вот давайте проверим это с помощью другого теста или с помощью критерия знаковых рангов Уилкоксона. В данном случае реализация находится в библиотеке SciPy, модуль stats и называется wilcoxon. Мы передаем туда наши данные. И давайте посмотрим, что мы видим. Видим, что значение статистики равняется 0 и p-value очень маленькая, то есть этот тест так же подтверждает, что нулевую гипотезу нужно отклонить. Последний критерий, который мы применяем — это перестановочный критерий. В рамках этого критерия мы проверяем гипотезу о том, что среднее равняется 0,5 против альтернативы о том, что среднее не равняется 0,5. Готовой реализации этого критерия нету, поэтому нам придется самим его реализовать. Ну это не очень сложно. Для начала давайте рассчитаем T-статистику. Это очень просто — нам с вами нужно просто посчитать сумму значений нашей выборки, при этом из каждого значения нужно вычесть среднее. Вот ровно это здесь делается, и получаем вот такую реализацию. Можем сразу посмотреть, чему равна T-статистика в случае с нашей выборкой, передаем туда среднее и видим, что в нашем случае этого назначения получается −0,4. Теперь нам нужно реализовать функцию для подсчета нулевого распределения. Так как в случае, если нулевая гипотеза справедлива и каждый из элементов выборки может с одинаковой вероятностью реализоваться как справа, так и слева от своего среднего, то для получения нулевого распределения нам нужно сделать следующее. Нужно взять все элементы выборки, вычесть из них среднее и далее сгенерировать на основе получившейся выборки набор выборок со всеми возможными перестановками знаков перед каждым элементом. Ну понятно, что таких выборок очень много, их ровно 2 в степени n, где n — размер исходной выборки. Поэтому для того, чтобы иметь возможность считать этот критерий быстрее, мы вводим дополнительный параметр max permutations, то есть максимальное количество перестановок, которые мы хотим перебрать. В данном случае у нас есть следующая логика. Вместо того чтобы генерировать все возможные комбинации знаков перед элементами выборки, мы с вами сгенерируем только несколько случайных и будем оценивать нулевое распределение относительно сгенерированных случайных выборок. Ну давайте посмотрим на реализацию. Она тоже очень понятная. Сначала мы просто вычитаем среднее из всех элементов выборки и дальше, в зависимости от того, указано ли количество max permutations, мы либо генерируем случайный набор последовательности знаков, либо честно перебираем все возможные знаки. Далее для подсчета нулевого распределения, мы просто суммируем значения элементов в получившихся подвыборках с учетом знаков, и возвращаем нулевое распределение. Вот давайте посмотрим на то, как это распределение выглядит. Помним, что это должно быть табличное распределение… Ну вот так оно и выглядит. Мы видим табличное распределение вот с центром в точке 0. Так, теперь давайте посмотрим на реализацию самого теста. Она тоже очень понятная. А так как мы с вами можем применять этот критерий как с двусторонними, так и с односторонними альтернативами, давайте сразу же помимо параметров sample mean и max permutation, добавим параметр «тип альтернативы». В данном случае two sided соответствует двусторонней альтернативе, less и greater — соответствующим односторонним. Итак, теперь для того чтобы применить тест, нам с вами нужно рассчитать T-статистику (мы уже реализовали функцию для этого), получить нулевое распределение, а дальше, в зависимости от того, какая альтернатива проверяется, вычислить p-value. Так как мы с вами имеем дело с небольшой выборкой – всего 16 элементов, мы можем честно построить все перестановки и посмотреть на значение p-value в этом случае. Вот давайте это сделаем. Видим, что это занимает совсем немного времени, и мы получаем p-value 0,16. Вот давайте сделаем то же самое, но возьмем только часть перестановок. Ну, допустим всего 10 000. Метод будет работать еще быстрее и видим, что p-value отличается не очень сильно, тоже 0,16. Соответственно, на этом уровне значимости, на уровне значимости 0,05 или на уровне значимости 0,1, мы отвергнуть нулевую гипотезу не можем. А мы на этом заканчиваем и в следующем видео потренируемся применять непараметрические критерии в случае двух связанных выборок.

[БЕЗ ЗВУКА] В этом видео мы поговорим про двухвыборочные непараметрические критерии для проверки статистических гипотез. Работать будем со случаем связных выборок. Решать будем следующую задачу. В рамках исследования оценивалась эффективность применения поведенческой терапии для лечения анорексии. Для 50 пациентов, проходивших эту терапию, известен вес «до» и вес «после» терапии. Соответственно, нам с вами нужно определить, являлась ли терапия эффективной. Итак, традиционно сначала загружаем данные. И давайте на них посмотрим. Видим, что структура данных довольно простая, перед нами data frame, состоящая из двух колонок, в первой для нас известен вес пациентов до операции, во второй – вес пациентов после операции. Так, давайте отрисуем гистограммы этих весов, посмотрим на них. Видим, что да, левая и правая границы гистограмм отличаются. Можно сказать, что гистограмма, построенная по данным после терапии немножечко сдвинута вправо относительно гистограммы, построенной до терапии, однако этого, конечно, недостаточно для того чтобы сделать вывод о том, что терапия оказалась эффективной. Давайте посмотрим на то, как изменялись средние веса. Видим, что средний вес после терапии также стал больше, однако это тоже недостаточно неточная оценка. Ну давайте еще сделаем интервальную оценку на средний вес. Так, это можно сделать с помощью метода zconfint, мы его уже разбирали. И вот давайте посмотрим, что мы получаем. Видим, что интервалы весов до терапии и после терапии пересекаются. То есть все равно сложно сделать однозначный вывод о том, что терапия помогла. Нужно применять критерий для провеки гипотез. Давайте рассмотрим гипотезу о том, что медиана веса до терапии и после терапии совпадают против двусторонней альтернативы о том, что они отличаются. Для того чтобы применять двухвыборочные критерии для проверки гипотез, для начала нам нужно посчитать попарные разности весов пациентов до и после терапии. Давайте это сделаем и посмотрим на то, как эта величина распределена. Мы видим, что основные значения колеблются около 0, ±5 килограмм. Теперь давайте применим критерий знаков. Будем тестировать гипотезу о том, что медианы весов до и после терапии равны, против альтернативы о том, что они не равны. Посчитать критерий знаков можно с помощью метода sign test из модуля StatsModules, однако, если помните, в прошлом видео мы передавали туда одну выборку, в данном случае мы сделаем то же самое, только вместо выборки передадим попарные разности на двух выборках. То есть, фактически это тоже выборка одна, но только в ней содержатся разности, посчитанные по двум связным выборкам. Давайте посмотрим, что мы получим. Видим, что значение статистики равняется 3 и p-value = 0,26. Видим, что p-value достаточно большое, поэтому мы с вами не можем отвергнуть нулевую альтернативу, соответственно, не можем сделать вывод о том, что у нас веса изменились, что терапия оказалась эффективной. Давайте посмотрим, быть может, с помощью критерия рангов Уилкоксона получится другой результат. Здесь хочется обратить ваше внимание на то, что эту функцию можно применять по-разному. С одной стороны, мы можем передать туда две выборки, с другой стороны, мы точно так же, как и в случае с критерием знаков, можем передать туда попарные разности. Вот давайте попробуем сделать и то, и другое, и, конечно же, нам хотелось бы, чтобы результат получился одинаковый. Итак, сначала передаем туда две выборки. Видим, что статистика равняется 131,5, и p-value получается 0,06. Ну, на самом деле p-value уже гораздо ниже, чем в предыдущем случае, однако все равно недостаточно низкое значение, чтобы, скажем, с уверенностью 0,05 отвергнуть эту гипотезу, нулевую гипотезу. Итак, пробуем запустить в другом режиме, и видим, что результат получается точно такой же. То есть можно сделать вывод о том, что можно делать обоими способами. Ну и вот, понимаем, что на уровне значимости 0,05 мы отвергнуть нулевую гипотезу не можем, но, однако, на уровне значимости 0,1 – можем. Двигаемся дальше. Подходим к перестановочному критерию. В данном случае критерий нам придется реализовать самостоятельно, однако на прошлом уроке мы уже это делали, поэтому давайте не будем подробно останавливаться на реализации. Первая функция, которая нам понадобится, это функция для вычисления t-статистики по выборке в реализуемое. Далее нам нужно обязательно уметь считать нулевое распределение. И давайте сразу же посмотрим, как это нулевое распределение будет выглядеть в случае наших данных. Ну, давайте остановимся на 10 000 перестановок. И посмотрим. Видим, что получилось табличное распределение, так, как мы и ожидали. Итак, теперь нам понадобится функция непосредственно для рассчета p-value. И теперь давайте это p-value рассчитаем. Ну вот, возьмем 1000 перестановок и посмотрим, что мы получили. Мы видим, что мы получили довольно маленькое значение p-value, всего лишь 0,04. Получается, что с помощью критерия перестановочного мы с вами можем отвергнуть нулевую гипотезу на уровне значимости 0,05. Может быть, мы взяли недостаточно много перестановок и нужно просто взять больше? Давайте возьмем вместо тысячи 50 000 и посмотрим, как изменится p-value. Так, видим, что это считается чуть дольше, но видим, что p-value на самом деле изменилось не очень сильно. Получается, что на уровне значимости 0,05 мы можем смело отвергать нулевую гипотезу и делать вывод о том, что, наверное, терапия оказалась эффективной. Наверняка вам интересно, почему же так получается, почему мы применяем разные критерии и вынуждены делать разные выводы. Давайте разбираться. Ну, во-первых, разные критерии по-разному оценивают среднее. В случае критерия знаков под «средним» мы с вами понимаем «медиану веса», а в случае перестановочного критерия под «средним» мы с вами понимаем «матожидание разности весов». Уже в этом месте начинаются разночтения. С другой стороны, разница есть в том, как много информации использует критерий. В частности, знаковые критерии используют только знаки перед нашими значениями и не учитывают абсолютные значения. Ранговые критерии используют только порядка. Перестановочный критерий уже использует гораздо больше информации, потому что он учитывает значение. Соответственно, в этом случае нам оказалось этого достаточно для того, чтобы отвергнуть нулевую гипотезу. Мы с вами на этом заканчиваем. На этом видео мы научились применять двухвыборочные непараметрические критерии в случае связных выборок. А в следующем видео мы с вами поговорим про несвязные выборки.

В этом видео мы заканчиваем рассматривать непараметрические критерии для проверки статистических гипотез, и в этот раз мы поговорим про двухвыборочные критерии в случае независимых выборок. Решать будем довольно интересную задачу. У нас есть данные о продажной стоимости недвижимости в Сиэтле для 50 сделок 2001 года и 50 сделок 2002 года. Нам нужно понять, изменилась ли в среднем цена. Итак, давайте загрузим данные, посмотрим на них и убедимся, что структура очень простая. У нас известна цена и известен год, за который эта цена измерялась. Давайте разделим данные по разным годам и построим гистограмму. Итак, видим, что по гистограмме довольно сложно понять, насколько изменились цены, поэтому давайте применим некоторые критерии, которые формально помогут нам проверить, изменилась ли цена в среднем или нет. Первый критерий, на который мы посмотрим, это ранговый критерий Манна-Уитни, то есть ранговый критерий, двухвыборочный, для независимых выборок. Будем рассматривать следующую альтернативу: медиана стоимости недвижимости в 2001 и 2002 годах совпадают. Против двусторонней альтернативы о том, что медианы не совпадают. Итак, давайте для начала выведем 95 % доверительный интервал для среднего. Сначала для 2001 года, потом для 2002 года. Видим, что они пересекаются. Пересечение довольно сильное, поэтому нам опять же сложно сделать выводы о том, изменились ли цены или нет. Единственное, что мы видим, что правый интервал доверительного интервала для 2002 года сильно правее. Поэтому мы можем предположить, что какие-то изменения были. Ну, теперь давайте это проверим. В случае рангового критерия мы проверяем гипотезу о том, что вероятность того, что значение из первой выборки будет больше, чем значение из второй выборки, равна вероятности того, что значение из второй выборки будет больше, чем значение из первой выборки. Альтернатива — то, что это не так. Для того чтобы этот критерий рассчитать, нам нужно воспользоваться функцией Манна-Уитни из модуля stats библиотеки SciPy. Передаем туда две наших выборки и смотрим, что мы получили. Перед нами значение статистики и p-value. p-value довольно большой, поэтому отвергнуть нулевую гипотезу мы не можем. Мы не можем сказать, что цены изменились. Давайте попробуем применить перестановочный критерий, может быть, в этом случае мы получим противоположный результат. В случае перестановочного критерия для независимых выборок, мы несколько по-другому сравниваем среднее. В данном случае мы с вами сравниваем функции распределения. Таким образом, нулевая гипотеза состоит в том, что функции распределения для первой и второй выборки одинаковы. Они совпадают. Альтернатива следующая: функция распределения одной выборки получается сдвигом на некоторую дельту из функции распределения на другой выборке. Итак, давайте это посчитаем. Для начала нам с вами нужно реализовать рассчет t-статистики. В этом случае он очень простой. Это просто разность средних первой и второй выборки. Делаем это. И дальше нам с вами нужно научиться считать нулевое распределение. В случае справедливости нулевой гипотезы любое значение, встреченное, например, в первой выборке, мы могли бы с тем же успехом встретить и во второй выборке. То есть если нулевая гипотеза справедлива, то мы можем равновероятно получить любое разделение исходных данных на две подвыборки. Поэтому давайте поступим следующим образом. Для того чтобы получить нулевое распределение, нам нужно с вами построить все возможные комбинации, все возможные разбиения данных на подвыборки, то есть, получается, построить все сочетания. Однако мы понимаем, что в случае существенных размеров хотя бы одной из выборок это довольно долго. Давайте сделаем следующим образом. Реализуем возможность ограничивать количество перестановок, которые мы рассматриваем. Для этого заведем переменную max combinations, максимальное количество комбинаций, и будем действовать следующим образом. Сначала объединим наши выборки в одну, также рассчитаем необходимые нам параметры, это размер первой выборки и размер объединенной выборки. И дальше поступим следующим образом: если нам задано ограничение на максимальное количество комбинаций, то давайте сгенерируем индексы для разбиения данных на первую и вторую выборку случайным образом. Если же нам такого ограничения не задано, то давайте явно переберем все возможные комбинации с помощью метода combinations из модуля itertools. Далее, после того как индексы мы получили, давайте просто построим разделение нашей выборки на две по соответствующим индексам и далее рассчитаем нужную статистику, то есть разницу средних по полученным разбиениям. Вот это у нас реализовано. И отдельно можно обратить внимание, что получение случайных разбиений, случайных индексов, реализовано с помощью функции get random combinations. Вот оно также перед нами. Итак, теперь давайте построим гистограмму для нашего нулевого распределения. В общем-то, выглядеть оно должно ну, не совсем, как нормальное, но несколько похоже, то есть, пик тоже должен быть в центре, он должен быть в нуле. Давайте посмотрим, как это выглядит. Ну, да, видим, что даже довольно красиво получилось, очень похоже на нормальное. Так, теперь давайте применим сам перестановочный критерий, для этого мы снова пользуемся уже привычной нам реализацией рассчета p-value. И давайте для начала ограничимся 10 000 перестановок. Для рассчета p-value воспользуемся функцией permutation test, ее реализация вам снова знакома, однако обратите внимание, что здесь мы заменяем статистику и заменяем нулевое распределение. И давайте рассчитаем p-value в случае ограничения на количество перестановок в 10 000. Видим, что мы получаем снова довольно большое значение p-value — 0,43. Оно не такое большое как в случае рангового критерия Манна-Уитни, но тоже достаточно большое для того, чтобы мы не смогли отвергнуть нулевую гипотезу. И давайте также рассчитаем значение p-value для 50 000 перестановок. Мы также получаем похожее значение 0,44. То есть мы видим, что ни один из критериев отвергнуть нулевую гипотезу нам не позволяет. То есть мы с вами не можем сказать, что цены изменились. На этом мы с вами заканчиваем изучение непараметрических критериев, а на следующей неделе вас ждет очень интересная тема «Поиск закономерностей и взаимосвязей в данных».